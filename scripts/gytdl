#! /usr/bin/bash
#*
#*                 _    __ _ _
#*  __ _ ___  __ _| |_ / _(_) |___ ___  WEBSITE: https://goatfiles.github.io
#* / _` / _ \/ _` |  _|  _| | / -_|_-<  REPOS: https://github.com/goatfiles
#* \__, \___/\__,_|\__|_| |_|_\___/__/  LICENCE: https://github.com/goatfiles/dotfiles/blob/main/LICENSE
#* |___/
#*          MAINTAINERS:
#*              AMTOINE: https://github.com/amtoine antoine#1306 7C5EE50BA27B86B7F9D5A7BA37AAE9B486CFF1AB
#*              ATXR:    https://github.com/atxr    atxr#6214    AF97503EDC65A06845114630F00A52147514670B
#*

# parse the arguments
OPTIONS=$(getopt -o hu:a: --long help,url:,archive: -n 'gytdl' -- "$@")
if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi
eval set -- "$OPTIONS"

# allow the user to change the environment variables.
[[ ! -v MUSIC_DIR ]] && MUSIC_DIR="$HOME/music"


usage () {
     #
     # the usage function.
     #
     echo "Usage: gytdl [-h] -u URL -a ARCHIVE"
     echo "Type -h or --help for the full help."
     exit 0
}


help () {
     #
     # the help function.
     #
     echo "gytdl:"
     echo "     a script to download music from youtube."
     echo ""
     echo "Usage:"
     echo "     gytdl [-h] -u URL -a ARCHIVE"
     echo ""
     echo "Switches:"
     echo "     -h/--help             shows this help."
     echo "     -u/--url              the url of the video or the playlist to download the sound from."
     echo "     -a/--archive          the name of the archive, namely \`<name_of_playlist>.pg\`, under the \`MUSIC_DIR\` directory."
     echo ""
     echo "Environment variables:"
     echo "     MUSIC_DIR             the location where to store the musics and the archive (defaults to '\$HOME/music')."
     exit 0
}


main () {
  #
  # TODO.
  #
     ACTION=""
     while [[ $# -gt 0 ]]; do
     case "$1" in
          -h | --help )     help ;;
          -u | --url )      ACTION="download"; URL="$2"; shift 2 ;;
          -a | --archive )  ACTION="download"; ARCHIVE="$2"; shift 2 ;;
          -- ) shift; break ;;
          * ) break ;;
     esac
     done

     # an action is required
     [ -z "$ACTION" ] && usage
     [ -z "$URL" ] && usage
     [ -z "$ARCHIVE" ] && usage

     youtube-dl \
          --ignore-errors \
          --yes-playlist \
          --continue \
          -f 249 \
          --extract-audio \
          --audio-format mp3 \
          --no-overwrites \
          --download-archive "$MUSIC_DIR/$ARCHIVE" \
          --output "$MUSIC_DIR/%(playlist)s/%(playlist)s - %(playlist_index)s - %(title)s.%(ext)s" \
          --add-metadata \
          --metadata-from-title "%(artist)s - %(title)s" \
          "$URL"
     #     --exec 'ffmpeg -y -loglevel repeat+info -i 'file:{}' -c copy -metadata 'album=DL31' 'file:{}.tmp'' \
     #     $1
}


main "$@"
