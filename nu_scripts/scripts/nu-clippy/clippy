#!/usr/bin/env nu

# check a file for common mistakes
def main [
    file: path  # the path to the script to check
    --no-mutable: bool  # disallow the use of the `mut` keyword
] {
    let ast = nu --ide-ast $file | from json

    if $no_mutable {
        let muts = $ast | where shape == shape_internalcall and content == mut
        if not ($muts | is-empty) {
            let span = metadata $file | get span
            error make {
                msg: $"(ansi red_bold)clippy::mutable_not_allowed(ansi reset)"
                label: {
                    text: $"found `mut` keyword at cursor positions ($muts | get span.start | str join ', ')"
                    start: $span.start
                    end: $span.end
                }
            }
        }
    }
}
